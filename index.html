<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Finance Dashboard ‚Äî Dashboard + Transactions + Budget + Savings</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      /* ====== Core UI (keeps your second file look & feel) ====== */
      * { margin:0; padding:0; box-sizing:border-box; }
      :root{
        --primary-color:#2b49cd;
        --text-secondary:#cbd5e1;
        --card-bg: rgba(255,255,255,0.04);
        --card-border: rgba(255,255,255,0.06);
        --shadow: 0 8px 30px rgba(0,0,0,0.45);
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --muted: #9aa6b2;
        --glass-bg: #1e1e2f;
      }
      body{
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(135deg,#667eea,#764ba2);
        color:#fff;
        min-height:100vh;
        -webkit-font-smoothing:antialiased;
      }

      .header{
        background: var(--card-bg);
        margin: 16px;
        padding: 14px 18px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border:1px solid var(--card-border);
        box-shadow: var(--shadow);
      }
      .logo{ display:flex; align-items:center; gap:8px; font-weight:700; }
      .balance-display { text-align:center; padding:8px 14px; background: rgba(255,255,255,0.02); border-radius:10px; }
      .balance-amount { font-weight:700; color:var(--success); }

      .btn { background:var(--primary-color); border:none; padding:8px 12px; border-radius:10px; cursor:pointer; color:#fff; }
      .btn-sm { padding:6px 10px; font-size:0.9rem; }

      .nav-tabs{ display:flex; gap:8px; padding:10px 18px; overflow:auto; margin: 0 16px; }
      .nav-tab{ background:rgba(255,255,255,0.03); color:var(--text-secondary); border:none; padding:8px 12px; border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:8px; }
      .nav-tab.active{ background:var(--primary-color); color:#fff; box-shadow: 0 6px 18px rgba(0,0,0,0.35); transform:translateY(-2px); }

      .container{ max-width:1200px; margin:18px auto; padding:0 16px; }

      .dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-bottom:18px; }
      .card{ background: var(--glass-bg); padding:14px; border-radius:12px; box-shadow: var(--shadow); border:1px solid var(--card-border); }
      .stat-card { text-align:center; }
      .stat-value{ font-size:1.6rem; font-weight:700; margin-bottom:6px; }
      .stat-label{ color:var(--muted); font-size:0.9rem; }

      .chart-container{ height:260px; margin-top:8px; }

      .transactions-table{ width:100%; border-collapse:collapse; margin-top:12px; }
      .transactions-table th, .transactions-table td{ padding:10px 8px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); color:var(--text-secondary); font-size:0.95rem; }
      .transactions-table td .amount { font-weight:700; color:#fff; }
      .transaction-income{ color:var(--success); }
      .transaction-expense{ color:var(--danger); }

      .recent-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
      .recent-item{ display:flex; align-items:center; gap:12px; padding:8px; border-radius:10px; background: rgba(255,255,255,0.02); }
      .cat-icon{ width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.05rem; flex-shrink:0; background:rgba(255,255,255,0.03); }
      .recent-info{ flex:1; }
      .recent-title{ font-weight:600; margin-bottom:4px; }
      .recent-meta{ color:var(--text-secondary); font-size:0.9rem; }

      .modal{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999; }
      .modal.active{ display:flex; }
      .modal-content{ background: var(--glass-bg); padding:18px; border-radius:12px; box-shadow:var(--shadow); width:420px; max-width:94%; border:1px solid var(--card-border); }
      .modal-content h3{ margin-bottom:12px; }
      .modal-content form{ display:flex; flex-direction:column; gap:10px; }
      .form-input, .form-select{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:#fff; }

      .action-btn{ background:none; border:none; cursor:pointer; color:var(--text-secondary); padding:6px; border-radius:8px; }
      .action-btn:hover{ background: rgba(255,255,255,0.02); color:#fff; }

      .progress { width:100%; height:12px; background: rgba(255,255,255,0.04); border-radius:8px; overflow:hidden; }
      .progress-fill { height:100%; width:0%; transition: width 0.4s ease; }

      @media (max-width:640px){
        .header{ flex-direction:column; align-items:stretch; gap:12px; }
        .nav-tabs{ padding-left:8px; padding-right:8px; }
      }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="logo"><span>üí∞</span><div>Finance Dashboard</div></div>

      <div class="balance-display">
        <div style="font-size:0.85rem; color:var(--text-secondary)">Total Balance</div>
        <div class="balance-amount" id="totalBalance">‚Çπ0</div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="openModal" class="btn btn-sm">‚ûï Add Transaction</button>
      </div>
    </header>

    <nav class="nav-tabs" id="navTabs">
      <button class="nav-tab active" data-tab="dashboard">üè† Dashboard</button>
      <button class="nav-tab" data-tab="transactions">üí≥ Transactions</button>
      <button class="nav-tab" data-tab="budget">üìä Budget</button>
      <button class="nav-tab" data-tab="savings">üéØ Savings</button>
      <button class="nav-tab" data-tab="bills">üìÖ Bills</button>
      <button class="nav-tab" data-tab="investments">üìà Investments</button>
      <button class="nav-tab" data-tab="reports">üìã Reports</button>
      <button class="nav-tab" data-tab="settings">‚öôÔ∏è Settings</button>
    </nav>

    <main class="container">
      <!-- DASHBOARD -->
      <section id="dashboard-tab" class="tab-content" style="display:block;">
        <div class="dashboard-grid">
          <div class="card stat-card">
            <div class="stat-value transaction-income" id="totalIncome">‚Çπ0</div>
            <div class="stat-label">Total Income</div>
          </div>
          <div class="card stat-card">
            <div class="stat-value transaction-expense" id="totalExpenses">‚Çπ0</div>
            <div class="stat-label">Total Expenses</div>
          </div>
          <div class="card stat-card">
            <div class="stat-value" id="totalSavings" style="color:var(--success)">‚Çπ0</div>
            <div class="stat-label">Total Savings</div>
          </div>
          <div class="card stat-card">
            <div class="stat-value" id="monthlyBudget" style="color:var(--text-secondary)">‚Çπ0</div>
            <div class="stat-label">Monthly Budget</div>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="font-size:1rem;">üìä Monthly Overview</h3>
            </div>
            <div class="chart-container">
              <canvas id="monthlyChart"></canvas>
            </div>
          </div>

          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="font-size:1rem;">ü•ß Expense Categories</h3>
            </div>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="font-size:1rem;">üí∏ Recent Transactions</h3>
              <button class="btn btn-sm" onclick="switchTab('transactions')">View All</button>
            </div>
            <div id="recentTransactions" class="recent-list"></div>
          </div>

          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="font-size:1rem;">üìÖ Upcoming Bills</h3>
              <button class="btn btn-sm" onclick="switchTab('bills')">Manage</button>
            </div>
            <div id="upcomingBills" style="margin-top:8px; color:var(--text-secondary);">No upcoming bills</div>
          </div>
        </div>
      </section>

      <!-- TRANSACTIONS -->
      <section id="transactions-tab" class="tab-content" style="display:none;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Recent Transactions</h2>
            <div style="display:flex; gap:8px; align-items:center;">
              <select id="categoryFilter" class="form-select" style="padding:6px 8px; border-radius:8px; background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.04);">
                <option value="">All categories</option>
                <option value="salary">Salary</option>
                <option value="food">Food</option>
                <option value="rent">Rent</option>
                <option value="travel">Travel</option>
                <option value="shopping">Shopping</option>
                <option value="entertainment">Entertainment</option>
                <option value="other">Other</option>
              </select>
              <button id="addTransactionBtn" class="btn btn-sm">Add</button>
            </div>
          </div>

          <table class="transactions-table" style="margin-top:12px;">
            <thead>
              <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Category</th>
                <th>Date</th>
                <th style="width:110px;text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- BUDGET -->
      <section id="budget-tab" class="tab-content" style="display:none;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Budget (Expense categories)</h2>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="openBudgetListBtn" class="btn btn-sm">Set Budget</button>
            </div>
          </div>

          <table class="transactions-table" style="margin-top:12px;">
            <thead>
              <tr>
                <th>Category</th>
                <th>Budget</th>
                <th>Spent (this month)</th>
                <th>Remaining</th>
                <th>Usage</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="budgetTableBody"></tbody>
          </table>
          <div style="margin-top:10px; color:var(--text-secondary); font-size:0.95rem;">
            Notes: Budgets are expense-only and calculated for the current month.
          </div>
        </div>
      </section>

      <!-- SAVINGS -->
      <section id="savings-tab" class="tab-content" style="display:none;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Savings Goals</h2>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="openSavingsBtn" class="btn btn-sm">Set Goal</button>
            </div>
          </div>

          <table class="transactions-table" style="margin-top:12px;">
            <thead>
              <tr>
                <th>Goal</th>
                <th>Target</th>
                <th>Saved</th>
                <th>Remaining</th>
                <th>Progress</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="savingsTableBody"></tbody>
          </table>

          <div style="margin-top:10px; color:var(--text-secondary); font-size:0.95rem;">
            Tip: To add money toward a goal, add an <strong>Income</strong> transaction and set the <em>Category</em> to the goal name or include its keyword (e.g. "Emergency", "Vacation").
          </div>
        </div>
      </section>

      <!-- Placeholder tabs -->
      <section id="savings-tab-dup" style="display:none;"></section>
      <section id="bills-tab" class="tab-content" style="display:none;"><div class="card"><h3>Bills & Reminders ‚Äî coming soon</h3></div></section>
      <section id="investments-tab" class="tab-content" style="display:none;"><div class="card"><h3>Investments ‚Äî coming soon</h3></div></section>
      <section id="reports-tab" class="tab-content" style="display:none;"><div class="card"><h3>Reports ‚Äî coming soon</h3></div></section>
      <section id="settings-tab" class="tab-content" style="display:none;"><div class="card"><h3>Settings ‚Äî coming soon</h3></div></section>
    </main>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3 id="modalTitle">Add Transaction</h3>
        <form id="transactionForm">
          <input type="text" id="tTitle" class="form-input" placeholder="Title (e.g., Salary)" required />
          <input type="number" id="tAmount" class="form-input" placeholder="Amount" step="0.01" required />
          <select id="tType" class="form-select" required>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input type="text" id="tCategory" class="form-input" placeholder="Category (e.g., Food or 'Emergency Fund')" />
          <input type="date" id="tDate" class="form-input" required />
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
            <button type="button" class="btn" id="cancelBtn">Cancel</button>
            <button type="submit" class="btn btn-sm" id="saveBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3 id="budgetModalTitle">Set Budget</h3>
        <form id="budgetForm">
          <label style="color:var(--text-secondary)">Category</label>
          <select id="budgetCategory" class="form-select" required>
            <option value="food">Food</option>
            <option value="travel">Travel</option>
            <option value="shopping">Shopping</option>
            <option value="rent">Rent</option>
            <option value="entertainment">Entertainment</option>
            <option value="other">Other</option>
          </select>
          <label style="color:var(--text-secondary)">Monthly Budget Amount</label>
          <input type="number" id="budgetAmount" class="form-input" placeholder="e.g., 5000" step="0.01" min="0" required />
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
            <button type="button" class="btn" id="cancelBudgetBtn">Cancel</button>
            <button type="submit" class="btn btn-sm" id="saveBudgetBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Savings Modal -->
    <div id="savingsModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h3 id="savingsModalTitle">Set Savings Goal</h3>
        <form id="savingsForm">
          <label style="color:var(--text-secondary)">Goal</label>
          <select id="savingsGoalSelect" class="form-select" required>
            <option value="emergency fund">Emergency Fund</option>
            <option value="vacation">Vacation</option>
            <option value="new car">New Car</option>
            <option value="home down payment">Home Down Payment</option>
            <option value="education">Education</option>
            <option value="other savings">Other Savings</option>
          </select>
          <label style="color:var(--text-secondary)">Target Amount</label>
          <input type="number" id="savingsTarget" class="form-input" placeholder="e.g., 20000" step="0.01" min="0" required />
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
            <button type="button" class="btn" id="cancelSavingsBtn">Cancel</button>
            <button type="submit" class="btn btn-sm" id="saveSavingsBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      /* ============================
         App state and DOM refs
         ============================ */
      const TX_KEY = 'transactions';
      const BUD_KEY = 'budgets';
      const SAV_KEY = 'savingsGoals';

      let transactions = JSON.parse(localStorage.getItem(TX_KEY) || '[]');
      let budgets = JSON.parse(localStorage.getItem(BUD_KEY) || '[]');
      let savingsGoals = JSON.parse(localStorage.getItem(SAV_KEY) || '[]');

      // DOM references
      const tabs = document.querySelectorAll('.nav-tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const openModalBtn = document.getElementById('openModal');
      const addTransactionBtn = document.getElementById('addTransactionBtn');
      const transactionModal = document.getElementById('transactionModal');
      const transactionForm = document.getElementById('transactionForm');
      const transactionsTableBody = document.getElementById('transactionsTableBody');
      const recentTransactionsEl = document.getElementById('recentTransactions');
      const totalBalanceEl = document.getElementById('totalBalance');
      const totalIncomeEl = document.getElementById('totalIncome');
      const totalExpensesEl = document.getElementById('totalExpenses');
      const totalSavingsEl = document.getElementById('totalSavings');
      const monthlyBudgetEl = document.getElementById('monthlyBudget');
      const monthlyChartEl = document.getElementById('monthlyChart');
      const categoryChartEl = document.getElementById('categoryChart');
      const categoryFilter = document.getElementById('categoryFilter');

      // Budget DOM
      const openBudgetListBtn = document.getElementById('openBudgetListBtn');
      const budgetModal = document.getElementById('budgetModal');
      const budgetForm = document.getElementById('budgetForm');
      const budgetCategoryInput = document.getElementById('budgetCategory');
      const budgetAmountInput = document.getElementById('budgetAmount');
      const budgetTableBody = document.getElementById('budgetTableBody');

      // Savings DOM
      const openSavingsBtn = document.getElementById('openSavingsBtn');
      const savingsModal = document.getElementById('savingsModal');
      const savingsForm = document.getElementById('savingsForm');
      const savingsGoalSelect = document.getElementById('savingsGoalSelect');
      const savingsTargetInput = document.getElementById('savingsTarget');
      const savingsTableBody = document.getElementById('savingsTableBody');

      // Charts
      let monthlyChart = null, categoryChart = null;

      // Misc
      let editIndex = null;
      let editingBudgetCategory = null;
      let editingSavingsGoal = null;

      /* ============================
         Utility helpers
         ============================ */
      function saveTransactions(){ localStorage.setItem(TX_KEY, JSON.stringify(transactions)); }
      function saveBudgets(){ localStorage.setItem(BUD_KEY, JSON.stringify(budgets)); }
      function saveSavings(){ localStorage.setItem(SAV_KEY, JSON.stringify(savingsGoals)); }

      function formatCurrency(val){
        const n = Number(val) || 0;
        return '‚Çπ' + n.toLocaleString(undefined, {maximumFractionDigits:2});
      }

      function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

      // category icons (simple)
      const categoryIcons = {
        salary: "üíº",
        food: "üçî",
        rent: "üè†",
        travel: "‚úàÔ∏è",
        shopping: "üõçÔ∏è",
        entertainment: "üé¨",
        other: "üì¶",
        "emergency fund": "üö®",
        vacation: "üèñÔ∏è",
        "new car": "üöó",
        "home down payment": "üè°",
        education: "üéì",
        "other savings": "üí∞"
      };

      function iconFor(cat){
        if(!cat) return categoryIcons.other;
        const key = String(cat).trim().toLowerCase();
        return categoryIcons[key] || categoryIcons.other;
      }

      /* ============================
         Tabs
         ============================ */
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelector('.nav-tab.active').classList.remove('active');
          tab.classList.add('active');
          switchTab(tab.dataset.tab);
        });
      });

      function switchTab(tabName){
        tabContents.forEach(tc => tc.style.display = 'none');
        const target = document.getElementById(tabName + '-tab');
        if(target) target.style.display = 'block';
        // refresh things when visiting tabs
        if(tabName === 'dashboard') updateDashboard();
        if(tabName === 'transactions') renderTransactions();
        if(tabName === 'budget') renderBudgets();
        if(tabName === 'savings') renderSavings();
      }

      /* ============================
         Transactions: render, add, edit, delete
         ============================ */
      function renderTransactions(){
        transactionsTableBody.innerHTML = '';
        const filter = categoryFilter.value?.toLowerCase() || '';
        transactions.forEach((t,i) => {
          if(filter && (t.category||'').toLowerCase() !== filter) return;
          const tr = document.createElement('tr');
          const amtClass = t.type === 'income' ? 'transaction-income' : 'transaction-expense';
          tr.innerHTML = `
            <td style="color:#fff;">${t.title || '‚Äî'}</td>
            <td><span class="amount ${amtClass}">${formatCurrency(t.amount)}</span></td>
            <td>${(t.type || '').charAt(0).toUpperCase() + (t.type||'').slice(1)}</td>
            <td>${t.category || 'Other'}</td>
            <td>${t.date || ''}</td>
            <td style="text-align:right;">
              <button class="action-btn edit-btn" data-index="${i}" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn delete-btn" data-index="${i}" title="Delete">üóëÔ∏è</button>
            </td>
          `;
          transactionsTableBody.appendChild(tr);
        });
      }

      // click handlers inside transactions table
      transactionsTableBody.addEventListener('click', (e) => {
        const del = e.target.closest('.delete-btn');
        const edit = e.target.closest('.edit-btn');
        if(del){
          const idx = Number(del.dataset.index);
          if(!isNaN(idx) && confirm('Delete this transaction?')){
            transactions.splice(idx,1);
            saveTransactions();
            renderAll();
          }
        }
        if(edit){
          const idx = Number(edit.dataset.index);
          if(!isNaN(idx)){
            editIndex = idx;
            const t = transactions[idx];
            document.getElementById('tTitle').value = t.title || '';
            document.getElementById('tAmount').value = t.amount || '';
            document.getElementById('tType').value = t.type || 'expense';
            document.getElementById('tCategory').value = t.category || '';
            document.getElementById('tDate').value = t.date || '';
            openTransactionModal(true);
          }
        }
      });

      // recent list small edit/delete
      recentTransactionsEl.addEventListener('click', (e) => {
        const d = e.target.closest('.small-delete');
        const ed = e.target.closest('.small-edit');
        if(d){
          const idx = Number(d.dataset.index);
          if(!isNaN(idx) && confirm('Delete this transaction?')){
            transactions.splice(idx,1);
            saveTransactions();
            renderAll();
          }
        }
        if(ed){
          const idx = Number(ed.dataset.index);
          if(!isNaN(idx)){
            editIndex = idx;
            const t = transactions[idx];
            document.getElementById('tTitle').value = t.title || '';
            document.getElementById('tAmount').value = t.amount || '';
            document.getElementById('tType').value = t.type || 'expense';
            document.getElementById('tCategory').value = t.category || '';
            document.getElementById('tDate').value = t.date || '';
            openTransactionModal(true);
          }
        }
      });

      // open/close transaction modal
      openModalBtn.addEventListener('click', ()=>{ editIndex=null; openTransactionModal(false); });
      addTransactionBtn.addEventListener('click', ()=>{ editIndex=null; openTransactionModal(false); });
      function openTransactionModal(forEdit=false){
        transactionModal.classList.add('active');
        document.getElementById('modalTitle').textContent = forEdit ? 'Edit Transaction' : 'Add Transaction';
      }
      function closeTransactionModal(){
        transactionModal.classList.remove('active');
        transactionForm.reset();
        editIndex = null;
      }
      document.getElementById('cancelBtn').addEventListener('click', ()=> closeTransactionModal());
      transactionModal.addEventListener('click', (e)=> { if(e.target === transactionModal) closeTransactionModal(); });

      // transaction submit
      transactionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('tTitle').value.trim();
        const amount = parseFloat(document.getElementById('tAmount').value) || 0;
        const type = document.getElementById('tType').value;
        const category = document.getElementById('tCategory').value.trim();
        const date = document.getElementById('tDate').value;

        const tx = { title, amount, type, category, date };

        if(editIndex !== null && !isNaN(editIndex)){
          transactions[editIndex] = tx;
        } else {
          transactions.push(tx);
        }
        saveTransactions();
        closeTransactionModal();
        renderAll();
        switchTab('dashboard');
      });

      categoryFilter.addEventListener('change', ()=> renderTransactions());

      /* ============================
         Dashboard totals & charts
         ============================ */
      function updateDashboard(){
        let totalIncome = 0, totalExpenses = 0;
        transactions.forEach(t => {
          const amt = Number(t.amount) || 0;
          if(t.type === 'income') totalIncome += amt;
          else totalExpenses += amt;
        });
        const totalBalance = totalIncome - totalExpenses;
        const totalSavings = calculateTotalSavedAcrossGoals();

        totalIncomeEl.textContent = formatCurrency(totalIncome);
        totalExpensesEl.textContent = formatCurrency(totalExpenses);
        totalSavingsEl.textContent = formatCurrency(totalSavings);
        totalBalanceEl.textContent = formatCurrency(totalBalance);

        // monthlyBudget = sum of all budgets
        const totalBud = budgets.reduce((s,b) => s + (Number(b.amount)||0), 0);
        monthlyBudgetEl.textContent = formatCurrency(totalBud);

        renderMonthlyChart();
        renderCategoryChart();
        renderRecentTransactions();
      }

      function renderRecentTransactions(){
        recentTransactionsEl.innerHTML = '';
        const sorted = [...transactions].sort((a,b) => {
          if(a.date && b.date) return new Date(b.date) - new Date(a.date);
          return 0;
        }).slice(0,6);
        if(sorted.length === 0){
          recentTransactionsEl.innerHTML = '<div style="color:var(--text-secondary)">No recent transactions</div>';
          return;
        }
        sorted.forEach((t)=>{
          const idx = transactions.indexOf(t);
          const item = document.createElement('div');
          item.className = 'recent-item';
          item.innerHTML = `
            <div class="cat-icon">${iconFor(t.category)}</div>
            <div class="recent-info">
              <div class="recent-title">${t.title || '‚Äî'} <span style="font-weight:600; margin-left:8px;" class="${t.type==='income'?'transaction-income':'transaction-expense'}">${formatCurrency(t.amount)}</span></div>
              <div class="recent-meta">${t.category || 'Other'} ‚Ä¢ ${t.date || ''}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button class="action-btn small-edit" data-index="${idx}">‚úèÔ∏è</button>
              <button class="action-btn small-delete" data-index="${idx}">üóëÔ∏è</button>
            </div>
          `;
          recentTransactionsEl.appendChild(item);
        });
      }

      // Monthly chart
      function renderMonthlyChart(){
        const map = {};
        transactions.forEach(t => {
          if(!t.date) return;
          const d = new Date(t.date);
          if(isNaN(d)) return;
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          const amt = Number(t.amount) || 0;
          map[key] = (map[key] || 0) + (t.type==='income' ? amt : -amt);
        });
        const now = new Date();
        const keys = [];
        for(let i=5;i>=0;i--){
          const dt = new Date(now.getFullYear(), now.getMonth()-i, 1);
          const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
          keys.push(key);
        }
        const labels = keys.map(k => {
          const [y,m] = k.split('-');
          return `${m}/${y.slice(-2)}`;
        });
        const data = keys.map(k => Math.round((map[k] || 0) * 100)/100);

        const ctx = monthlyChartEl.getContext('2d');
        if(monthlyChart){
          monthlyChart.data.labels = labels;
          monthlyChart.data.datasets[0].data = data;
          monthlyChart.update();
        } else {
          monthlyChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets:[{ label:'Net cashflow', data, fill:true, tension:0.35, borderWidth:2, pointRadius:3 }]},
            options: {
              responsive:true, maintainAspectRatio:false,
              plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx => formatCurrency(ctx.raw) } } },
              scales:{ x:{ grid:{ display:false }, ticks:{ color: 'var(--text-secondary)' } }, y:{ ticks:{ color:'var(--text-secondary)', callback: v => '‚Çπ'+v }, grid:{ color:'transparent' } } }
            }
          });
        }
      }

      // Category chart (expenses)
      function renderCategoryChart(){
        const counts = {};
        transactions.forEach(t=>{
          if(t.type !== 'expense') return;
          const c = (t.category || 'Other').toLowerCase();
          counts[c] = (counts[c] || 0) + (Number(t.amount)||0);
        });
        const labels = Object.keys(counts);
        const dataVals = labels.map(l => Math.round(counts[l]*100)/100);

        const ctx = categoryChartEl.getContext('2d');
        if(categoryChart){
          categoryChart.data.labels = labels;
          categoryChart.data.datasets[0].data = dataVals;
          categoryChart.update();
        } else {
          categoryChart = new Chart(ctx, {
            type: 'pie',
            data: { labels, datasets:[{ data:dataVals }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color: 'var(--text-secondary)' } } } }
          });
        }
      }

      /* ============================
         Budget: fixed categories (expense-only)
         ============================ */
      const fixedBudgetCategories = ['food','travel','shopping','rent','entertainment','other'];

      function getBudgetFor(category){
        return budgets.find(b => b.category === category) || null;
      }

      function spentThisMonthForCategory(category){
        const now = new Date();
        const month = now.getMonth(), year = now.getFullYear();
        return transactions.filter(t=>{
          if(t.type !== 'expense') return false;
          const c = (t.category||'').toLowerCase();
          if(c !== category) return false;
          const d = new Date(t.date);
          if(isNaN(d)) return false;
          return d.getMonth() === month && d.getFullYear() === year;
        }).reduce((s,t)=> s + (Number(t.amount)||0), 0);
      }

      function renderBudgets(){
        budgetTableBody.innerHTML = '';
        fixedBudgetCategories.forEach(cat => {
          const bud = getBudgetFor(cat);
          const budgetAmt = bud ? Number(bud.amount) : 0;
          const spent = Math.round(spentThisMonthForCategory(cat) * 100) / 100;
          const remaining = Math.round((budgetAmt - spent) * 100) / 100;
          const percent = budgetAmt ? (spent / budgetAmt) * 100 : 0;
          let color = percent > 100 ? 'var(--danger)' : percent >= 70 ? 'var(--warning)' : 'var(--success)';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="color:#fff;">${capitalize(cat)}</td>
            <td>${formatCurrency(budgetAmt)}</td>
            <td>${formatCurrency(spent)}</td>
            <td>${formatCurrency(remaining)}</td>
            <td>
              <div class="progress"><div class="progress-fill" style="width:${Math.min(percent,100)}%; background:${color};"></div></div>
            </td>
            <td style="text-align:right;">
              <button class="action-btn edit-budget-btn" data-cat="${cat}">‚úèÔ∏è</button>
              <button class="action-btn delete-budget-btn" data-cat="${cat}">üóëÔ∏è</button>
            </td>
          `;
          budgetTableBody.appendChild(tr);
        });
      }

      // Budget table event handlers
      budgetTableBody.addEventListener('click', (e)=>{
        const editBtn = e.target.closest('.edit-budget-btn');
        const delBtn = e.target.closest('.delete-budget-btn');
        if(editBtn){
          const cat = editBtn.dataset.cat;
          editingBudgetCategory = cat;
          budgetCategoryInput.value = cat;
          const bud = getBudgetFor(cat);
          budgetAmountInput.value = bud ? bud.amount : '';
          budgetModal.classList.add('active');
        }
        if(delBtn){
          const cat = delBtn.dataset.cat;
          if(confirm(`Delete budget for ${capitalize(cat)}?`)){
            budgets = budgets.filter(b => b.category !== cat);
            saveBudgets();
            renderBudgets();
            updateDashboard();
          }
        }
      });

      openBudgetListBtn.addEventListener('click', ()=>{
        editingBudgetCategory = null;
        budgetCategoryInput.value = 'food';
        budgetAmountInput.value = '';
        budgetModal.classList.add('active');
      });

      document.getElementById('cancelBudgetBtn').addEventListener('click', ()=> {
        budgetModal.classList.remove('active');
        budgetForm.reset();
        editingBudgetCategory = null;
      });
      budgetModal.addEventListener('click', (e)=> { if(e.target === budgetModal) { budgetModal.classList.remove('active'); editingBudgetCategory = null; } });

      budgetForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const cat = (budgetCategoryInput.value || '').toLowerCase();
        const amt = parseFloat(budgetAmountInput.value) || 0;
        const existing = budgets.find(b => b.category === cat);
        if(existing){
          existing.amount = amt;
        } else {
          budgets.push({ category: cat, amount: amt });
        }
        saveBudgets();
        budgetModal.classList.remove('active');
        budgetForm.reset();
        editingBudgetCategory = null;
        renderBudgets();
        updateDashboard();
        switchTab('budget');
      });

      /* ============================
         Savings: fixed goals
         ============================ */
      // Fixed goals with keywords for matching transaction categories (case-insensitive contains)
      const fixedSavingsGoals = [
        { key: 'emergency fund', label: 'Emergency Fund' },
        { key: 'vacation', label: 'Vacation' },
        { key: 'new car', label: 'New Car' },
        { key: 'home down payment', label: 'Home Down Payment' },
        { key: 'education', label: 'Education' },
        { key: 'other savings', label: 'Other Savings' },
      ];

      // get goal by key
      function getSavingsGoal(key){
        return savingsGoals.find(g => g.key === key) || null;
      }

      // sum income transactions that match a goal (if transaction category contains the goal keyword)
      function savedForGoalThisMonth(goalKey){
        const now = new Date();
        const month = now.getMonth(), year = now.getFullYear();
        // match if category includes the goalKey (or equals)
        return transactions.filter(t=>{
          if(t.type !== 'income') return false;
          const cat = (t.category || '').toLowerCase();
          if(!cat) return false;
          if(!cat.includes(goalKey)) return false;
          const d = new Date(t.date);
          if(isNaN(d)) return false;
          return d.getMonth() === month && d.getFullYear() === year;
        }).reduce((s,t)=> s + (Number(t.amount)||0), 0);
      }

      // total saved across all goals (for dashboard's totalSavings)
      function calculateTotalSavedAcrossGoals(){
        return fixedSavingsGoals.reduce((sum, g) => {
          const saved = savedForGoalThisMonth(g.key);
          return sum + saved;
        }, 0);
      }

      function renderSavings(){
        savingsTableBody.innerHTML = '';
        fixedSavingsGoals.forEach(g=>{
          const existing = getSavingsGoal(g.key);
          const target = existing ? Number(existing.target) : 0;
          const saved = Math.round(savedForGoalThisMonth(g.key) * 100) / 100;
          const remaining = Math.round((target - saved) * 100) / 100;
          const percent = target ? (saved / target) * 100 : 0;
          let color = percent >= 100 ? 'var(--success)' : percent >= 70 ? 'var(--warning)' : '#3b82f6';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="color:#fff;">${g.label}</td>
            <td>${formatCurrency(target)}</td>
            <td>${formatCurrency(saved)}</td>
            <td>${formatCurrency(remaining)}</td>
            <td>
              <div class="progress"><div class="progress-fill" style="width:${Math.min(percent,100)}%; background:${color};"></div></div>
            </td>
            <td style="text-align:right;">
              <button class="action-btn edit-savings-btn" data-key="${g.key}">‚úèÔ∏è</button>
              <button class="action-btn delete-savings-btn" data-key="${g.key}">üóëÔ∏è</button>
            </td>
          `;
          savingsTableBody.appendChild(tr);
        });
      }

      // savings table handlers
      savingsTableBody.addEventListener('click', (e)=>{
        const edit = e.target.closest('.edit-savings-btn');
        const del = e.target.closest('.delete-savings-btn');
        if(edit){
          const key = edit.dataset.key;
          editingSavingsGoal = key;
          const existing = getSavingsGoal(key);
          savingsGoalSelect.value = key;
          savingsTargetInput.value = existing ? existing.target : '';
          savingsModal.classList.add('active');
        }
        if(del){
          const key = del.dataset.key;
          if(confirm('Delete savings target for ' + capitalize(key) + '?')){
            savingsGoals = savingsGoals.filter(s => s.key !== key);
            saveSavings();
            renderSavings();
            updateDashboard();
          }
        }
      });

      openSavingsBtn.addEventListener('click', ()=>{
        editingSavingsGoal = null;
        savingsGoalSelect.value = fixedSavingsGoals[0].key;
        savingsTargetInput.value = '';
        savingsModal.classList.add('active');
      });

      document.getElementById('cancelSavingsBtn').addEventListener('click', ()=> {
        savingsModal.classList.remove('active');
        savingsForm.reset();
        editingSavingsGoal = null;
      });
      savingsModal.addEventListener('click', (e)=> { if(e.target === savingsModal) { savingsModal.classList.remove('active'); editingSavingsGoal = null; } });

      savingsForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const key = savingsGoalSelect.value;
        const target = parseFloat(savingsTargetInput.value) || 0;
        const existing = savingsGoals.find(s => s.key === key);
        if(existing) existing.target = target;
        else savingsGoals.push({ key, target });
        saveSavings();
        savingsModal.classList.remove('active');
        savingsForm.reset();
        editingSavingsGoal = null;
        renderSavings();
        updateDashboard();
        switchTab('savings');
      });

      /* ============================
         Global render & initialization
         ============================ */
      function renderAll(){
        renderTransactions();
        renderBudgets();
        renderSavings();
        updateDashboard();
      }

      // initial render
      renderAll();

      // expose switchTab for inline onclick usage
      window.switchTab = switchTab;

      // keyboard Esc to close modals
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          if(transactionModal.classList.contains('active')) closeTransactionModal();
          if(budgetModal.classList.contains('active')) { budgetModal.classList.remove('active'); editingBudgetCategory = null; }
          if(savingsModal.classList.contains('active')) { savingsModal.classList.remove('active'); editingSavingsGoal = null; }
        }
      });

      // storage events (in case multiple windows)
      window.addEventListener('storage', (e)=>{
        if(e.key === TX_KEY) { transactions = JSON.parse(e.newValue || '[]'); renderAll(); }
        if(e.key === BUD_KEY) { budgets = JSON.parse(e.newValue || '[]'); renderBudgets(); updateDashboard(); }
        if(e.key === SAV_KEY) { savingsGoals = JSON.parse(e.newValue || '[]'); renderSavings(); updateDashboard(); }
      });

      /* ============================
         End of script
         ============================ */
    </script>
  </body>
</html>
